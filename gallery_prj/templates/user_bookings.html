{% extends 'base.html' %}
{% load static %}

{% block title %}–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è{% endblock %}
{% block body_class %}my-bookings-page{% endblock %}

{% block content %}
<div class="bookings-container">
    <div class="bookings-header">
        <h1 class="bookings-title">–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h1>
        <a href="/booking/create/" class="new-booking-btn">
            <span class="btn-icon">+</span>
            –ù–æ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
        </a>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="bookings-stats">
        <div class="stat-card">
            <div class="stat-icon">üìÖ</div>
            <div class="stat-content">
                <h3>{{ stats.total }}</h3>
                <p>–í—Å–µ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">‚è≥</div>
            <div class="stat-content">
                <h3>{{ stats.pending }}</h3>
                <p>–û–∂–∏–¥–∞—é—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-content">
                <h3>{{ stats.confirmed }}</h3>
                <p>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üéØ</div>
            <div class="stat-content">
                <h3>{{ stats.upcoming }}</h3>
                <p>–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ</p>
            </div>
        </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="bookings-filters">
        <div class="filter-tabs">
            <a href="/booking/my/" class="filter-tab {% if not status_filter %}active{% endif %}">
                –í—Å–µ
            </a>
            <a href="/booking/my/?status=pending" class="filter-tab {% if status_filter == 'pending' %}active{% endif %}">
                –û–∂–∏–¥–∞—é—Ç ({{ stats.pending }})
            </a>
            <a href="/booking/my/?status=confirmed" class="filter-tab {% if status_filter == 'confirmed' %}active{% endif %}">
                –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã ({{ stats.confirmed }})
            </a>
            <a href="/booking/my/?status=completed" class="filter-tab {% if status_filter == 'completed' %}active{% endif %}">
                –í—ã–ø–æ–ª–Ω–µ–Ω—ã
            </a>
            <a href="/booking/my/?status=cancelled" class="filter-tab {% if status_filter == 'cancelled' %}active{% endif %}">
                –û—Ç–º–µ–Ω–µ–Ω—ã
            </a>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π -->
    {% if page_obj.object_list %}
    <div class="bookings-list">
        {% for booking in page_obj.object_list %}
        <div class="booking-card booking-card-{{ booking.status }}">
            <div class="booking-card-header">
                <div class="booking-id">#{{ booking.id|slice:":8" }}</div>
                <div class="booking-status status-{{ booking.status }}">
                    {{ booking.get_status_display }}
                </div>
            </div>

            <div class="booking-card-body">
                <h3 class="booking-service">{{ booking.service.name }}</h3>

                <div class="booking-details">
                    <div class="detail-item">
                        <span class="detail-icon">üìÖ</span>
                        <span class="detail-text">
                            {{ booking.booking_date|date:"d.m.Y" }} –≤ {{ booking.booking_time|time:"H:i" }}
                        </span>
                    </div>

                    <div class="detail-item">
                        <span class="detail-icon">‚è±Ô∏è</span>
                        <span class="detail-text">{{ booking.duration }} —á–∞—Å–æ–≤</span>
                    </div>

                    {% if booking.location %}
                    <div class="detail-item">
                        <span class="detail-icon">üìç</span>
                        <span class="detail-text">{{ booking.location }}</span>
                    </div>
                    {% endif %}

                    <div class="detail-item">
                        <span class="detail-icon">üí∞</span>
                        <span class="detail-text">{{ booking.get_total_price }} —Ä—É–±.</span>
                    </div>
                </div>

                {% if booking.client_message %}
                <div class="booking-message">
                    <strong>–í–∞—à–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è:</strong>
                    <p>{{ booking.client_message|truncatechars:150 }}</p>
                </div>
                {% endif %}
            </div>

            <div class="booking-card-footer">
                <div class="footer-left">
                    <span class="booking-date">
                        –°–æ–∑–¥–∞–Ω–æ: {{ booking.created_at|date:"d.m.Y" }}
                    </span>
                </div>

                <div class="footer-right">
                    <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–ª—è –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤, –∫—Ä–æ–º–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö) -->
                    {% if booking.status != 'completed' %}
                    <form method="post" action="/booking/{{ booking.id }}/delete/" class="delete-form"
                          onsubmit="return confirmDelete()" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="delete-btn" title="–£–¥–∞–ª–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ">
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>

            {% if booking.status == 'pending' and booking.is_upcoming %}
            <div class="booking-card-actions">
                <a href="/booking/{{ booking.id }}/cancel/" class="cancel-link">
                    –û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                </a>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if page_obj.has_other_pages %}
    <div class="pagination">
        {% if page_obj.has_previous %}
            <a href="?page=1{% if status_filter %}&status={{ status_filter }}{% endif %}" class="page-link">¬´</a>
            <a href="?page={{ page_obj.previous_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}" class="page-link">‚Äπ</a>
        {% endif %}

        <span class="current-page">
            –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}
        </span>

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}" class="page-link">‚Ä∫</a>
            <a href="?page={{ page_obj.paginator.num_pages }}{% if status_filter %}&status={{ status_filter }}{% endif %}" class="page-link">¬ª</a>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <div class="no-bookings">
        <div class="no-bookings-icon">üìÖ</div>
        <h3>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</h3>
        <p>–ó–∞–±—Ä–æ–Ω–∏—Ä—É–π—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é —Å—ä–µ–º–∫—É –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!</p>
        <a href="/booking/create/" class="cta-button">
            –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å—ä–µ–º–∫—É
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
{% endblock %}


{% block extra_js %}
<script>
function confirmDelete() {
    return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.');
}

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —É–¥–∞–ª–µ–Ω–∏–∏, –µ—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä –≤ URL
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('deleted')) {
        showNotification('–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ', 'success');
    }
    if (urlParams.has('error')) {
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
    }
});

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        background: rgba(26, 26, 26, 0.95);
        color: white;
        padding: 1rem 2rem;
        border-radius: 8px;
        border-left: 4px solid #666;
        z-index: 9999;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s ease-out;
    `;

    if (type === 'success') {
        notification.style.borderLeftColor = '#4CAF50';
    } else if (type === 'error') {
        notification.style.borderLeftColor = '#f44336';
    }

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-out forwards';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}