{% extends 'base.html' %}

{% block title %}Создание бронирования{% endblock %}

{% block content %}
<div class="card">
    <h1>Новое бронирование</h1>

    <div class="booking-steps">
        <div class="step active">1. Выбор услуги</div>
        <div class="step">2. Дата и время</div>
        <div class="step">3. Контактные данные</div>
        <div class="step">4. Подтверждение</div>
    </div>

    <form method="POST" action="/booking/create/">
        {% csrf_token %}

        <!-- Step 1: Service Selection -->
        <div id="step-1" class="booking-step">
            <h2>Выберите услугу</h2>
            <div class="form-group">
                <label class="form-label">Услуга:</label>
                <select name="service" class="form-input" required>
                    <option value="">-- Выберите услугу --</option>
                    {% for service in form.service.field.queryset %}
                        <option value="{{ service.id }}" {% if service.id == form.initial.service.id %}selected{% endif %}>
                            {{ service.name }} - {{ service.price }} руб.
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="mt-3">
                <button type="button" class="btn next-step">Далее</button>
            </div>
        </div>

        <!-- Step 2: Date & Time -->
        <div id="step-2" class="booking-step hidden">
            <h2>Выберите дату и время</h2>

            <div class="form-group">
                <label class="form-label">Дата съемки:</label>
                <input type="date" name="booking_date" class="form-input" min="{{ min_date|date:'Y-m-d' }}" required>
            </div>

            <div class="form-group">
                <label class="form-label">Время начала:</label>
                <input type="time" name="booking_time" class="form-input" min="09:00" max="21:00" required>
            </div>

            <div class="form-group">
                <label class="form-label">Продолжительность (часы):</label>
                <input type="number" name="duration" class="form-input" min="1" max="8" value="2" required>
            </div>

            <div class="mt-3">
                <button type="button" class="btn btn-secondary prev-step">Назад</button>
                <button type="button" class="btn next-step">Далее</button>
            </div>
        </div>

        <!-- Step 3: Contact Details -->
        <div id="step-3" class="booking-step hidden">
            <h2>Контактная информация</h2>

            <div class="form-group">
                <label class="form-label">Ваше имя:</label>
                <input type="text" name="client_name" class="form-input" value="{{ user.get_full_name|default:user.username }}" required>
            </div>

            <div class="form-group">
                <label class="form-label">Телефон:</label>
                <input type="tel" name="client_phone" class="form-input" placeholder="+7 (999) 999-99-99" required>
            </div>

            <div class="form-group">
                <label class="form-label">Email:</label>
                <input type="email" name="client_email" class="form-input" value="{{ user.email }}" required>
            </div>

            <div class="form-group">
                <label class="form-label">Место съемки:</label>
                <input type="text" name="location" class="form-input" placeholder="Адрес или название места">
            </div>

            <div class="mt-3">
                <button type="button" class="btn btn-secondary prev-step">Назад</button>
                <button type="button" class="btn next-step">Далее</button>
            </div>
        </div>

        <!-- Step 4: Confirmation -->
        <div id="step-4" class="booking-step hidden">
            <h2>Подтверждение</h2>

            <div class="card mb-3">
                <h3>Детали бронирования:</h3>
                <div id="summary-details"></div>
            </div>

            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" name="confirm_terms" required>
                    Я согласен с условиями бронирования
                </label>
            </div>

            <div class="mt-3">
                <button type="button" class="btn btn-secondary prev-step">Назад</button>
                <button type="submit" class="btn">Создать бронирование</button>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentStep = 1;
    const totalSteps = 4;
    const steps = document.querySelectorAll('.step');

    function showStep(stepNumber) {
        document.querySelectorAll('.booking-step').forEach(el => el.classList.add('hidden'));
        document.getElementById(`step-${stepNumber}`).classList.remove('hidden');

        steps.forEach((step, index) => {
            step.classList.remove('active');
            if (index < stepNumber) step.classList.add('active');
        });
    }

    document.querySelectorAll('.next-step').forEach(btn => {
        btn.addEventListener('click', function() {
            if (validateStep(currentStep)) {
                currentStep++;
                if (currentStep === totalSteps) {
                    updateSummary();
                }
                showStep(currentStep);
            }
        });
    });

    document.querySelectorAll('.prev-step').forEach(btn => {
        btn.addEventListener('click', function() {
            currentStep--;
            showStep(currentStep);
        });
    });

    function validateStep(step) {
        // Простая валидация для примера
        if (step === 1) {
            const service = document.querySelector('[name="service"]').value;
            if (!service) {
                alert('Выберите услугу');
                return false;
            }
        }
        return true;
    }

    function updateSummary() {
        const formData = new FormData(document.querySelector('form'));
        const summary = `
            <p><strong>Услуга:</strong> ${document.querySelector('[name="service"] option:checked').textContent}</p>
            <p><strong>Дата:</strong> ${formData.get('booking_date')}</p>
            <p><strong>Время:</strong> ${formData.get('booking_time')}</p>
            <p><strong>Продолжительность:</strong> ${formData.get('duration')} ч.</p>
            <p><strong>Имя:</strong> ${formData.get('client_name')}</p>
            <p><strong>Телефон:</strong> ${formData.get('client_phone')}</p>
            <p><strong>Email:</strong> ${formData.get('client_email')}</p>
        `;
        document.getElementById('summary-details').innerHTML = summary;
    }

    // Устанавливаем минимальную дату (завтра)
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.querySelector('[name="booking_date"]').min = tomorrow.toISOString().split('T')[0];

    showStep(1);
});
</script>
{% endblock %}